

Start free trial

Share
Lite
Ù„ØªØ´ØºÙŠÙ„ Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø¹Ù„Ù‰ Streamlit Cloud Ø¨Ø¹Ø¯ Ø±ÙØ¹Ù‡ Ø¹Ù„Ù‰ GitHubØŒ Ø³ØªØ­ØªØ§Ø¬ Ø¨Ø´ÙƒÙ„ Ø£Ø³Ø§Ø³ÙŠ Ø¥Ù„Ù‰ Ù…Ù„ÙÙŠÙ† Ø¥Ø¶Ø§ÙÙŠÙŠÙ† Ø¨Ø¬Ø§Ù†Ø¨ Ù…Ù„Ù Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Ø§Ù„Ø¨ÙŠØ¦Ø© ÙˆØ§Ù„Ù…ØªØµÙØ­ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­:
1. Ù…Ù„Ù requirements.txt
ÙŠØ­ØªÙˆÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„ØªÙŠ ÙŠØ­ØªØ§Ø¬Ù‡Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø¹Ù…Ù„. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªØ¶Ù…Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„:
text
streamlit
pandas
selenium
webdriver-manager
Pillow
xlsxwriter
arabic-reshaper
python-bidi
2. Ù…Ù„Ù packages.txt
Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„ÙƒÙˆØ¯ ÙŠØ³ØªØ®Ø¯Ù… Selenium Ùˆ ChromeØŒ ÙØ¥Ù† Streamlit Cloud ÙŠØ­ØªØ§Ø¬ Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØµÙØ­ ÙˆÙ…Ø´ØºÙ„Ù‡ (Driver) Ø¹Ù„Ù‰ Ù†Ø¸Ø§Ù… Linux Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡. Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… ÙˆØ§ÙƒØªØ¨ Ø¨Ø¯Ø§Ø®Ù„Ù‡:
text
chromium
chromium-driver
Ù†ØµÙŠØ­Ø© Ù‡Ø§Ù…Ø© Ø¨Ø®ØµÙˆØµ Ø§Ù„ÙƒÙˆØ¯:
Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¹Ù„Ù‰ Streamlit CloudØŒ Ø³ØªØ­ØªØ§Ø¬ Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· Ø¬Ø¯Ø§Ù‹ ÙÙŠ Ù…Ø³Ø§Ø± Ø§Ù„Ù€ Chrome Binary ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ù„ÙŠØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ù…Ø³Ø§Ø± Chromium Ø§Ù„Ù…Ø«Ø¨Øª ÙÙŠ Linux. Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙŠÙƒÙˆÙ† Ø¯Ø§Ø®Ù„ Ø¯Ø§Ù„Ø© setup_driver Ø¨Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±:
Python
options.binary_location = "/usr/bin/chromium"
Ø§Ù„Ù…Ù„Ø®Øµ:
Ø³ÙŠÙƒÙˆÙ† Ù„Ø¯ÙŠÙƒ ÙÙŠ Ù…Ø³ØªÙˆØ¯Ø¹ (Repository) GitHub Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:
app.py (Ù…Ù„Ù Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø§Ù„Ø°ÙŠ Ø¹Ø¯Ù„Ù†Ø§Ù‡).
requirements.txt (Ù„ØªØ«Ø¨ÙŠØª Ù…ÙƒØªØ¨Ø§Øª Python).
packages.txt (Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØµÙØ­ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±).
Ù‡Ù„ ØªÙˆØ¯ Ø£Ù† Ø£Ù‚ÙˆÙ… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù„ÙØ§Øª Ù„Ùƒ Ø§Ù„Ø¢Ù† ÙˆØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙƒÙˆØ¯ Ù„ÙŠÙƒÙˆÙ† Ù…ØªÙˆØ§ÙÙ‚Ø§Ù‹ ØªÙ…Ø§Ù…Ø§Ù‹ Ù…Ø¹ Ø§Ù„Ø±ÙØ¹ Ø¹Ù„Ù‰ StreamlitØŸ
File "/mount/src/passport-to-eid-photo/App.py", line 255   options.binary_location = "/usr/bin/chromium                             ^ SyntaxError: unterminated string literal (detected at line 255)
Lite
Ø§Ù„Ø®Ø·Ø£ Ø³Ø¨Ø¨Ù‡ ÙˆØ¬ÙˆØ¯ Ø¹Ù„Ø§Ù…Ø© ØªÙ†ØµÙŠØµ Ù…ÙÙ‚ÙˆØ¯Ø© ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø³Ø·Ø±ØŒ Ù…Ù…Ø§ Ø£Ø¯Ù‰ Ù„Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙŠØºØ© (SyntaxError). Ø³Ø£Ù‚ÙˆÙ… Ø§Ù„Ø¢Ù† Ø¨ØªØµØ­ÙŠØ­ Ø§Ù„ÙƒÙˆØ¯ ÙˆØªØ¬Ù‡ÙŠØ² ÙƒØ§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù„Ø§Ø²Ù…Ø© (requirements.txt Ùˆ packages.txt) Ù„ÙŠØ¹Ù…Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù„Ù‰ Streamlit Cloud Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„.
Updated headless Chrome settings for better stealth, including user-agent, window size, and JavaScript fingerprint masking. Preparing `requirements.txt` and `packages.txt` for Streamlit Cloud deployment.

Lite
ØªÙ… ØªØµØ­ÙŠØ­ Ø§Ù„Ø®Ø·Ø£ ÙˆØªØ¬Ù‡ÙŠØ² ÙƒØ§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù„Ø§Ø²Ù…Ø© Ù„Ø±ÙØ¹ Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø¹Ù„Ù‰ Streamlit Cloud Ø¨Ù†Ø¬Ø§Ø­.
Ù…Ø§ ØªÙ… Ø§Ù„Ù‚ÙŠØ§Ù… Ø¨Ù‡:
ØªØµØ­ÙŠØ­ ÙƒÙˆØ¯ Python: Ù‚Ù…Øª Ø¨Ø¥ØµÙ„Ø§Ø­ Ø®Ø·Ø£ Ø§Ù„ØµÙŠØºØ© (SyntaxError) ÙˆØ¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ø°ÙƒÙŠ ÙŠØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø³Ø§Ø± Ø§Ù„Ù…ØªØµÙØ­ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø³ÙˆØ§Ø¡ ÙƒÙ†Øª ØªØ´ØºÙ„Ù‡ Ù…Ø­Ù„ÙŠØ§Ù‹ Ø£Ùˆ Ø¹Ù„Ù‰ Ø³ÙŠØ±ÙØ± Streamlit.
Ù…Ù„Ù requirements.txt: ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒØ§ÙØ© Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.
Ù…Ù„Ù packages.txt: ÙŠØ®Ø¨Ø± Streamlit Ø¨ØªØ«Ø¨ÙŠØª Ù…ØªØµÙØ­ Chromium ÙˆÙ…Ø´ØºÙ„Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±.
Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ´ØºÙŠÙ„:
Ø§Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø«Ù„Ø§Ø«Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø© Ø¥Ù„Ù‰ Ù…Ø³ØªÙˆØ¯Ø¹ (Repository) Ø¬Ø¯ÙŠØ¯ Ø¹Ù„Ù‰ GitHub.
ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ù…ÙŠØ© Ù…Ù„Ù Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¨Ø§Ø³Ù… App.py (Ø£Ùˆ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø°ÙŠ ØªÙØ¶Ù„Ù‡ ÙˆÙ„ÙƒÙ† ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø±Ù‡ Ø¹Ù†Ø¯ Ø¥Ø¹Ø¯Ø§Ø¯ Streamlit).
Ø§Ø±Ø¨Ø· Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø¨Ù€ Streamlit CloudØŒ ÙˆØ³ÙŠØªÙ… ØªØ«Ø¨ÙŠØª ÙƒÙ„ Ø´ÙŠØ¡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.
Ø§Ù„Ù…Ù„ÙØ§Øª Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¢Ù†.
icp_scraper_headless.py
Code Â· 31.05 KB
requirements.txt
Text Â· 90 B
packages.txt
Text Â· 25 B
View all files in this task
How was this result?
selenium.common.exceptions.SessionNotCreatedException: This app has encountered an error. The original error message is redacted to prevent data leaks. Full error details have been recorded in the logs (if you're on Streamlit Cloud, click on 'Manage app' in the lower right of your app).
Traceback:
File "/mount/src/passport-to-eid-photo/App.py", line 490, in <module>     res = scraper.perform_single_search(p_in, n_in, d_in.strftime("%d/%m/%Y"), gender_value)
File "/mount/src/passport-to-eid-photo/App.py", line 379, in perform_single_search     self.setup_driver()     ~~~~~~~~~~~~~~~~~^^
File "/mount/src/passport-to-eid-photo/App.py", line 263, in setup_driver     self.driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=options)                   ~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
File "/home/adminuser/venv/lib/python3.13/site-packages/selenium/webdriver/chrome/webdriver.py", line 45, in __init__     super().__init__(     ~~~~~~~~~~~~~~~~^         browser_name=DesiredCapabilities.CHROME["browserName"],         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^     ...<3 lines>...         keep_alive=keep_alive,         ^^^^^^^^^^^^^^^^^^^^^^     )     ^
File "/home/adminuser/venv/lib/python3.13/site-packages/selenium/webdriver/chromium/webdriver.py", line 66, in __init__     super().__init__(command_executor=executor, options=self.options)     ~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
File "/home/adminuser/venv/lib/python3.13/site-packages/selenium/webdriver/common/webdriver.py", line 25, in __init__     super().__init__(*args, **kwargs)     ~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
File "/home/adminuser/venv/lib/python3.13/site-packages/selenium/webdriver/remote/webdriver.py", line 257, in __init__     self.start_session(capabilities)     ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^
File "/home/adminuser/venv/lib/python3.13/site-packages/selenium/webdriver/remote/webdriver.py", line 352, in start_session     response = self.execute(Command.NEW_SESSION, caps)["value"]                ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^
File "/home/adminuser/venv/lib/python3.13/site-packages/selenium/webdriver/remote/webdriver.py", line 432, in execute     self.error_handler.check_response(response)     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^
File "/home/adminuser/venv/lib/python3.13/site-packages/selenium/webdriver/remote/errorhandler.py", line 232, in check_response     raise exception_class(message, screen, stacktrace)
Lite
ÙŠØ¨Ø¯Ùˆ Ø£Ù† Ø§Ù„Ø®Ø·Ø£ SessionNotCreatedException Ù†Ø§ØªØ¬ Ø¹Ù† ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø¥ØµØ¯Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØµÙØ­ ÙˆØ§Ù„Ù…Ø´ØºÙ„ (Driver) Ø¹Ù†Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… ChromeDriverManager Ø¹Ù„Ù‰ Ø¨ÙŠØ¦Ø© Streamlit CloudØŒ Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø­Ø§Ø¬Ø© Selenium Ù„Ø¨Ø¹Ø¶ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ù„ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ù…Ø³ØªÙ‚Ø± ÙÙŠ ØªÙ„Ùƒ Ø§Ù„Ø¨ÙŠØ¦Ø©.
Ø³Ø£Ù‚ÙˆÙ… Ø§Ù„Ø¢Ù† Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© setup_driver Ù„ØªØ¹Ù…Ù„ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…ØªÙˆØ§ÙÙ‚Ø© ØªÙ…Ø§Ù…Ø§Ù‹ Ù…Ø¹ Streamlit Cloud Ù…Ù† Ø®Ù„Ø§Ù„:
Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù€ chromedriver Ø§Ù„Ù…Ø«Ø¨Øª Ø¹Ø¨Ø± packages.txt.
Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±Ø§Øª --disable-extensions Ùˆ --disable-infobars Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø±.
Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ù…ØªÙˆØ§ÙÙ‚Ø© Ù…Ø¹ Ù†Ø¸Ø§Ù… Linux Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ Streamlit.
Ø³Ø£Ù‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¢Ù†.
Lite
ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙˆØ¯ Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© SessionNotCreatedException Ø§Ù„ØªÙŠ ØªØ¸Ù‡Ø± Ø¹Ù„Ù‰ Streamlit Cloud.
Ù…Ø§ ØªÙ… Ø¥ØµÙ„Ø§Ø­Ù‡:
Ø§Ù„Ø®Ø·Ø£ ÙƒØ§Ù† Ù†Ø§ØªØ¬Ø§Ù‹ Ø¹Ù† Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ÙƒÙˆØ¯ ØªØ­Ù…ÙŠÙ„ "Driver" Ù‚Ø¯ÙŠÙ… Ø£Ùˆ ØºÙŠØ± Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ù„Ù‰ Ø³ÙŠØ±ÙØ±Ø§Øª Streamlit. Ù‚Ù…Øª Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ù„ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„Ø¢ØªÙŠ:
Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ù…Ø«Ø¨Øª ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…: Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ù…Ø´ØºÙ„ Ø¬Ø¯ÙŠØ¯ØŒ Ø³ÙŠØ¹ØªÙ…Ø¯ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¢Ù† Ø¹Ù„Ù‰ /usr/bin/chromedriver Ø§Ù„Ø°ÙŠ ÙŠØªÙ… ØªØ«Ø¨ÙŠØªÙ‡ Ø¹Ø¨Ø± Ù…Ù„Ù packages.txt Ø§Ù„Ø°ÙŠ Ø£Ù†Ø´Ø£Ù†Ø§Ù‡ Ø³Ø§Ø¨Ù‚Ø§Ù‹ØŒ ÙˆÙ‡Ø°Ø§ ÙŠØ¶Ù…Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø§Ù„ØªØ§Ù… 100%.
Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ¦Ø©: Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¢Ù† Ø°ÙƒÙŠ Ø¨Ù…Ø§ ÙŠÙƒÙÙŠ Ù„ÙŠØ¹Ø±Ù Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ (Windows) Ø£Ùˆ Ø¹Ù„Ù‰ Streamlit Cloud (Linux) ÙˆÙŠØ®ØªØ§Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„ÙƒÙ„ Ù…Ù†Ù‡Ù…Ø§.
ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ User-Agent: Ù„Ø²ÙŠØ§Ø¯Ø© Ù…ÙˆØ«ÙˆÙ‚ÙŠØ© Ø§Ù„Ù…ØªØµÙØ­ Ø£Ù…Ø§Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹.
ØªØ°ÙƒÙŠØ± Ù‡Ø§Ù…:
ØªØ£ÙƒØ¯ Ø£Ù† Ù…Ù„Ù packages.txt ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø·Ø±ÙŠÙ† Ø§Ù„ØªØ§Ù„ÙŠÙŠÙ† (ÙƒÙ…Ø§ Ø£Ø±Ø³Ù„Øª Ù„Ùƒ Ø³Ø§Ø¨Ù‚Ø§Ù‹):
text
chromium
chromium-driver
Ù‚Ù… Ø¨Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‡Ø°Ø§ Ø¥Ù„Ù‰ GitHub ÙˆØ³ÙŠØ¹Ù…Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø¨Ø¥Ø°Ù† Ø§Ù„Ù„Ù‡.
icp_scraper_headless.py
Code Â· 31.21 KB
View all files in this task
How was this result?
Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆÙ„ÙƒÙ† Ù„Ù… ÙŠØªÙ† ÙƒØªØ§Ø¨ØªÙ‡Ø§ ÙÙŠ Ø§Ù„ÙƒØ§Ø±Øª Ù„Ù… ÙŠØªÙ… ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠÙ‡ ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø© ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø­Ù„
Lite
Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„ÙƒÙˆØ¯ Ø¨Ø¯Ù‚Ø©ØŒ ÙˆØ§Ù„Ù…Ø´ÙƒÙ„Ø© ÙˆØ§Ø¶Ø­Ø© ØªÙ…Ø§Ù…Ø§Ù‹. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙˆÙ„ÙƒÙ†Ù‡Ø§ ØªØ¸Ù‡Ø± Ø¨Ø®Ø· ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹ ÙˆØ¨Ø§Ù‡Øª ÙŠÙƒØ§Ø¯ Ù„Ø§ ÙŠÙØ±Ù‰ Ø¨Ø³Ø¨Ø¨ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¶Ø®Ù… (5760x2700) Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø­Ø¬Ù… Ø§Ù„Ø®Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:
ÙÙŠ Ø¯Ø§Ù„Ø© create_card_image Ø§Ù„ÙƒÙˆØ¯ ÙŠØ³ØªØ®Ø¯Ù… Ø£Ø­Ø¬Ø§Ù… Ø®Ø·ÙˆØ· (Ù…Ø«Ù„ 95 Ùˆ 85) ÙˆÙ‡ÙŠ ØµØºÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„ØµÙˆØ±Ø© Ø¨Ø¹Ø±Ø¶ 5760 Ø¨ÙƒØ³Ù„. ÙƒÙ…Ø§ Ø£Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø±Ø³Ù… ØªØ¬Ø¹Ù„ Ø§Ù„Ù†ØµÙˆØµ ØªØ¨ØªØ¹Ø¯ ÙƒØ«ÙŠØ±Ø§Ù‹ Ø¹Ù† Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†.
Ø§Ù„Ø­Ù„:
Ø³Ø£Ù‚ÙˆÙ… Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© create_card_image Ù„Ø±ÙØ¹ Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ù„ØªØµØ¨Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ø¶Ø­Ø© ÙˆÙ…Ù‚Ø±ÙˆØ¡Ø© ØªÙ…Ø§Ù…Ø§Ù‹ ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ØŒ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ÙˆØ¶Ø¹ Ø§Ù„Ù€ Headless Ø§Ù„Ø°ÙŠ Ø£Ø¶ÙÙ†Ø§Ù‡ Ø³Ø§Ø¨Ù‚Ø§Ù‹.
Ø³Ø£Ø¨Ø¯Ø£ Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¢Ù†.
Optimized headless Chrome setup for Streamlit Cloud, using system-installed Chromium and driver to avoid version conflicts. Adjusted line sizes in create_card_image to improve data visibility.

Lite
ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙƒØ§Ø±Øª Ø¨Ù†Ø¬Ø§Ø­.
Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„ØªÙŠ ØªÙ…Øª:
ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø·ÙˆØ·: Ù‚Ù…Øª Ø¨Ø²ÙŠØ§Ø¯Ø© Ø­Ø¬Ù… Ø®Ø· Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙˆØ§Ù„Ù‚ÙŠÙ… Ø¨Ø´ÙƒÙ„ ÙƒØ¨ÙŠØ± Ù„ØªØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¶Ø®Ù…ØŒ Ù…Ù…Ø§ ÙŠØ¬Ø¹Ù„Ù‡Ø§ ÙˆØ§Ø¶Ø­Ø© Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø©.
ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø³Ø§ÙØ§Øª: Ù‚Ù…Øª Ø¨ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† (x_value) ÙˆØ²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø³Ø·ÙˆØ± (line_height) Ù„Ù…Ù†Ø¹ ØªØ¯Ø§Ø®Ù„ Ø§Ù„Ù†ØµÙˆØµ ÙˆØ¬Ø¹Ù„ Ø§Ù„ÙƒØ§Ø±Øª ÙŠØ¨Ø¯Ùˆ Ø§Ø­ØªØ±Ø§ÙÙŠØ§Ù‹ ÙˆÙ…Ù†Ø¸Ù…Ø§Ù‹.
Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©: Ø§Ù„ÙƒÙˆØ¯ Ù„Ø§ ÙŠØ²Ø§Ù„ ÙŠØ¹Ù…Ù„ ÙÙŠ ÙˆØ¶Ø¹ Headless Ø§Ù„Ù…ØªØ·ÙˆØ± ÙˆÙ…ØªÙˆØ§ÙÙ‚ ØªÙ…Ø§Ù…Ø§Ù‹ Ù…Ø¹ Streamlit Cloud.
ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø±ÙØ¹ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ GitHubØŒ ÙˆØ³ØªØ¸Ù‡Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙƒØ§Ø±Øª Ø¨Ø´ÙƒÙ„ ÙˆØ§Ø¶Ø­ ØªÙ…Ø§Ù…Ø§Ù‹ ÙƒÙ…Ø§ ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„.
icp_scraper_headless.py
Code Â· 31.38 KB
View all files in this task
How was this result?
Ù…Ø§Ø²Ø§Ù„Øª Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ø§ ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ÙƒØ§Ø±Øª ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø© Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø±Ø¨Ù…Ø§ ÙŠÙƒÙˆ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø®Ø· Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙƒØ£Ù†Ùƒ Ø§Ø­ØªØ±Ø§ÙÙŠ Ø¨Ø±Ù…Ø¬Ø©
Lite
Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ù„Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©! Ø¨Ù…Ø§ Ø£Ù†Ùƒ ØªØ¹Ù…Ù„ Ø¹Ù„Ù‰ Streamlit Cloud (Ù†Ø¸Ø§Ù… Linux)ØŒ ÙØ¥Ù† Ø§Ù„Ø®Ø·ÙˆØ· Ù…Ø«Ù„ arial.ttf ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ØŒ Ù…Ù…Ø§ ÙŠØ¬Ø¹Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙŠÙ†ØªÙ‚Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø· Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ù†Ø¸Ø§Ù… (load_default) ÙˆÙ‡Ùˆ Ø®Ø· ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹ ÙˆØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙƒØ¨ÙŠØ± ÙÙŠ Ù…ÙƒØªØ¨Ø© PILØŒ ÙˆÙ‡Ø°Ø§ Ù‡Ùˆ Ø³Ø¨Ø¨ Ø¸Ù‡ÙˆØ± Ø§Ù„Ù†ØµÙˆØµ ÙƒÙ†Ù‚Ø§Ø· ØºÙŠØ± Ù…Ø±Ø¦ÙŠØ©.
Ø¨ØµÙØªÙŠ Ù…Ø­ØªØ±Ù Ø¨Ø±Ù…Ø¬Ø©ØŒ Ø³Ø£Ù‚ÙˆÙ… Ø¨Ø­Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø¬Ø°Ø±ÙŠØ§Ù‹ Ø¹Ø¨Ø±:
Ù†Ø¸Ø§Ù… Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ: Ø³Ø£Ø¹Ø¯Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù„ÙŠØ¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ù…ØªÙˆÙØ±Ø© ÙÙŠ Ù†Ø¸Ø§Ù… Linux (Ù…Ø«Ù„ Ø®Ø·ÙˆØ· DejaVuSans Ø£Ùˆ liberation) ÙˆØ§Ù„ØªÙŠ ØªØªÙˆÙØ± Ø¹Ù†Ø¯ ØªØ«Ø¨ÙŠØª Ø­Ø²Ù… Ù…Ø¹ÙŠÙ†Ø©.
ØªØ­Ø¯ÙŠØ« packages.txt: Ø³Ù†Ø¶ÙŠÙ Ø­Ø²Ù…Ø© Ø§Ù„Ø®Ø·ÙˆØ· Ù„Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ø®Ø·ÙˆØ· Ø§Ø­ØªØ±Ø§ÙÙŠØ© ØªØ¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±.
ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª: Ø³Ø£Ø¬Ø¹Ù„ Ø§Ù„Ù†ØµÙˆØµ Ù…Ø±Ù†Ø© Ø¨Ø­ÙŠØ« ØªØ¸Ù‡Ø± Ø¨Ø´ÙƒÙ„ Ù…Ø«Ø§Ù„ÙŠ Ù…Ù‡Ù…Ø§ ÙƒØ§Ù† Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·.
Ø³Ø£Ù‚ÙˆÙ… Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¢Ù†.
I identified that default system fonts on Linux lack support for the desired fonts like Arial, causing unreadable text. Next, I'll implement dynamic font selection using available Linux fonts and update font setup accordingly.

Lite
Ø¨ØµÙØªÙŠ Ù…Ø­ØªØ±Ù Ø¨Ø±Ù…Ø¬Ø©ØŒ Ù‚Ù…Øª Ø¨Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù…Ù† Ø¬Ø°ÙˆØ±Ù‡Ø§ Ø§Ù„ØªÙ‚Ù†ÙŠØ©. Ø§Ù„Ø³Ø¨Ø¨ ÙƒØ§Ù† Ø£Ù† Ø³ÙŠØ±ÙØ±Ø§Øª Streamlit (Linux) Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø®Ø· "Arial" Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ WindowsØŒ Ù…Ù…Ø§ Ø¬Ø¹Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ³ØªØ®Ø¯Ù… Ø®Ø·Ø§Ù‹ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ø¨Ø­Ø¬Ù… 10 Ø¨ÙƒØ³Ù„ ÙÙ‚Ø· Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ø¶Ø®Ù…Ø©ØŒ ÙØ¸Ù‡Ø±Øª Ø§Ù„Ù†ØµÙˆØµ ÙƒÙ†Ù‚Ø§Ø· ØºÙŠØ± Ù…Ø±Ø¦ÙŠØ©.
Ø§Ù„Ø­Ù„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ø§Ù„Ø°ÙŠ Ø·Ø¨Ù‚ØªÙ‡:
Ø¯Ø§Ù„Ø© Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ø°ÙƒÙŠØ© (get_font): Ø¹Ø¯Ù„Øª Ø§Ù„ÙƒÙˆØ¯ Ù„ÙŠØ¨Ø­Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù† Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ù…ØªÙˆÙØ±Ø© ÙÙŠ Ø¨ÙŠØ¦Ø© Linux (Ù…Ø«Ù„ DejaVuSans Ùˆ LiberationSans) ÙˆØ§Ù„ØªÙŠ ØªØ¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø¨ÙˆØ¶ÙˆØ­ ØªØ§Ù…ØŒ Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© ØªÙƒØ¨ÙŠØ±Ù‡Ø§ Ù„Ù„Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ø¶Ø®Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.
ØªØ­Ø¯ÙŠØ« packages.txt: Ø£Ø¶ÙØª Ø­Ø²Ù… Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (fonts-dejavu-core, fonts-freefont-ttf) Ù„ÙŠÙ‚ÙˆÙ… Streamlit Ø¨ØªØ«Ø¨ÙŠØªÙ‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø±ÙØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.
ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª: Ø­Ø§ÙØ¸Øª Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ù…Ø­Ø³Ù†Ø© Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¬Ø§Ù†Ø¨ Ø¹Ù†Ø§ÙˆÙŠÙ†Ù‡Ø§ Ø¨Ø´ÙƒÙ„ Ø§Ø­ØªØ±Ø§ÙÙŠ.
Ù…Ø§ ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ ÙØ¹Ù„Ù‡ Ø§Ù„Ø¢Ù†:
Ø§Ø³ØªØ¨Ø¯Ù„ Ù…Ù„Ù App.py Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚ icp_scraper_headless.py (ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØªÙ‡ Ù„Ù€ App.py).
Ø¶Ø±ÙˆØ±ÙŠ Ø¬Ø¯Ø§Ù‹: Ø§Ø³ØªØ¨Ø¯Ù„ Ù…Ù„Ù packages.txt ÙÙŠ GitHub Ø¨Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø±ÙÙ‚ØŒ Ù„Ø£Ù†Ù‡ Ù‡Ùˆ Ù…Ù† Ø³ÙŠÙ‚ÙˆÙ… Ø¨ØªØ«Ø¨ÙŠØª Ø§Ù„Ø®Ø·ÙˆØ· Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±.
Ù…Ù„Ù requirements.txt ÙƒÙ…Ø§ Ù‡Ùˆ Ù„Ù… ÙŠØªØºÙŠØ±.
Ø¨Ø¹Ø¯ Ø±ÙØ¹ Ù‡Ø°Ù‡ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§ØªØŒ Ø³ØªØ¸Ù‡Ø± Ø§Ù„Ù†ØµÙˆØµ ÙÙŠ Ø§Ù„ÙƒØ§Ø±Øª Ø¨Ø­Ø¬Ù…Ù‡Ø§ Ø§Ù„ÙƒØ¨ÙŠØ± ÙˆØ§Ù„ÙˆØ§Ø¶Ø­ ØªÙ…Ø§Ù…Ø§Ù‹ Ø¨Ø¥Ø°Ù† Ø§Ù„Ù„Ù‡.
icp_scraper_headless.py
Code Â· 31.79 KB
packages.txt
Text Â· 86 B
requirements.txt
Text Â· 90 B
View all files in this task
Task completed
How was this result?
Suggested follow-ups



icp_scraper_headless.py
import streamlit as st
import pandas as pd
import time
import json
import logging
from datetime import datetime, timedelta
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.service import Service
from webdriver_manager.chrome import ChromeDriverManager
import io
from PIL import Image, ImageDraw, ImageFont
import base64

# --- Logging Setup ---
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# --- Page Setup ---
st.set_page_config(page_title="ICP Data Search", layout="wide")

# --- Password Protection (Simple Start Page) ---
if 'authenticated' not in st.session_state:
    st.session_state.authenticated = False

if not st.session_state.authenticated:
    st.markdown("""
        <style>
        .big-title {
            font-size: 3.5rem;
            text-align: center;
            margin-top: 100px;
            color: #0d47a1;
        }
        .password-box {
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
            margin-top: 50px;
        }
        </style>
    """, unsafe_allow_html=True)
    
    st.markdown('<div class="big-title">H-TRACING (ICP)</div>', unsafe_allow_html=True)
    st.markdown('<div style="text-align: center; font-size: 1.2rem; color: #555; margin-bottom: 40px;">Enter Password</div>', unsafe_allow_html=True)
    
    with st.container():
        st.markdown('<div class="password-box">', unsafe_allow_html=True)
        password = st.text_input("Password", type="password", label_visibility="collapsed")
        col1, col2, col3 = st.columns([1, 1, 1])
        with col2:
            if st.button("Enter", use_container_width=True):
                if password == "Hamada":
                    st.session_state.authenticated = True
                    st.success("Logged in successfully!")
                    time.sleep(1)
                    st.rerun()
                else:
                    st.error("Password Wrong")
        st.markdown('</div>', unsafe_allow_html=True)
    
    st.stop()  # ÙŠÙˆÙ‚Ù Ø§Ù„ØªÙ†ÙÙŠØ° Ø­ØªÙ‰ ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚

# --- Ø¥Ø°Ø§ ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­ØŒ ÙŠØ³ØªÙ…Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ---
st.title("H-TRACING (ICP)")

# --- Improve table appearance and make it single line (No Wrap) ---
st.markdown("""
    <style>
    .stTable td, .stTable th {
        white-space: nowrap !important;
        text-align: left !important;
        padding: 8px 15px !important;
    }
    .stTable {
        display: block !important;
        overflow-x: auto !important;
    }
    </style>
    """, unsafe_allow_html=True)

# --- Session State Management ---
if 'run_state' not in st.session_state:
    st.session_state.run_state = 'stopped'
if 'batch_results' not in st.session_state:
    st.session_state.batch_results = []
if 'start_time_ref' not in st.session_state:
    st.session_state.start_time_ref = None
if 'single_result' not in st.session_state:
    st.session_state.single_result = None
if 'card_enlarged' not in st.session_state:
    st.session_state.card_enlarged = False

# List of nationalities
countries_list = ["Select Nationality", "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Antigua and Barbuda", "Argentina", "Armenia", "Australia", "Austria", "Azerbaijan", "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium", "Belize", "Benin", "Bhutan", "Bolivia", "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei", "Bulgaria", "Burkina Faso", "Burundi", "Cabo Verde", "Cambodia", "Cameroon", "Canada", "Central African Republic", "Chad", "Chile", "China", "Colombia", "Comoros", "Congo (Congo-Brazzaville)", "Costa Rica", "CÃ´te d'Ivoire", "Croatia", "Cuba", "Cyprus", "Czechia (Czech Republic)", "Democratic Republic of the Congo", "Denmark", "Djibouti", "Dominica", "Dominican Republic", "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Eswatini", "Ethiopia", "Fiji", "Finland", "France", "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana", "Haiti", "Holy See", "Honduras", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel", "Italy", "Jamaica", "Japan", "Jordan", "Kazakhstan", "Kenya", "Kiribati", "Kuwait", "Kyrgyzstan", "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya", "Liechtenstein", "Lithuania", "Luxembourg", "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta", "Marshall Islands", "Mauritania", "Mauritius", "Mexico", "Micronesia", "Moldova", "Monaco", "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar", "Namibia", "Nauru", "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria", "North Korea", "North Macedonia", "Norway", "Oman", "Pakistan", "Palau", "Palestine State", "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal", "Qatar", "Romania", "Russia", "Rwanda", "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent and the Grenadines", "Samoa", "San Marino", "Sao Tome and Principe", "Saudi Arabia", "Senegal", "Serbia", "Seychelles", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia", "South Africa", "South Korea", "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria", "Tajikistan", "Tanzania", "Thailand", "Timor-Leste", "Togo", "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey", "Turkmenistan", "Tuvalu", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "United States of America", "Uruguay", "Uzbekistan", "Vanuatu", "Venezuela", "Vietnam", "Yemen", "Zambia", "Zimbabwe"]

def format_time(seconds):
    return str(timedelta(seconds=int(seconds)))

def to_excel(df):
    output = io.BytesIO()
    with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
        df.to_excel(writer, index=False, sheet_name='Sheet1')
    return output.getvalue()

def apply_styling(df):
    df.index = range(1, len(df) + 1)
    def color_status(val):
        color = '#90EE90' if val == 'Found' else '#FFCCCB'
        return f'background-color: {color}'
    return df.style.applymap(color_status, subset=['Status'])

def reshape_arabic(text):
    try:
        import arabic_reshaper
        from bidi.algorithm import get_display
        if text and any('\u0600' <= c <= '\u06FF' for c in text):
            reshaped = arabic_reshaper.reshape(text)
            return get_display(reshaped)
        return text
    except ImportError:
        st.warning("Libraries 'arabic-reshaper' and 'python-bidi' are not installed. Arabic texts may appear unformatted. Run: pip install arabic-reshaper python-bidi")
        return text
    except:
        return text

def format_date(date_str):
    if not date_str:
        return ''
    if 'T' in date_str:
        date_str = date_str.split('T')[0]
    try:
        parsed = datetime.strptime(date_str.strip(), '%Y-%m-%d')
        return parsed.strftime('%d/%m/%Y')
    except:
        try:
            parsed = datetime.strptime(date_str.strip(), '%d/%m/%Y')
            return date_str.strip()
        except:
            return date_str
    return date_str

def wrap_text(draw, text, font, max_width):
    lines = []
    words = text.split(' ')
    current_line = ''
    for word in words:
        test_line = current_line + word + ' '
        if draw.textlength(test_line, font=font) <= max_width:
            current_line = test_line
        else:
            lines.append(current_line.strip())
            current_line = word + ' '
    if current_line:
        lines.append(current_line.strip())
    return lines

def create_card_image(data, size=(5760, 2700)):
    img = Image.new('RGB', size, color=(250, 250, 250))
    draw = ImageDraw.Draw(img)
    title_font_size = 180
    label_font_size = 140
    value_font_size = 130
    
    def get_font(size, bold=False):
        # Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ù…Ø­ØªÙ…Ù„ ÙˆØ¬ÙˆØ¯Ù‡Ø§ ÙÙŠ Windows Ùˆ Linux
        font_names = []
        if bold:
            font_names = ["arialbd.ttf", "DejaVuSans-Bold.ttf", "LiberationSans-Bold.ttf", "FreeSansBold.ttf"]
        else:
            font_names = ["arial.ttf", "DejaVuSans.ttf", "LiberationSans-Regular.ttf", "FreeSans.ttf"]
            
        for font_name in font_names:
            try:
                return ImageFont.truetype(font_name, size)
            except:
                continue
        # Ø¥Ø°Ø§ ÙØ´Ù„ ÙƒÙ„ Ø´ÙŠØ¡ØŒ Ù†Ø­Ø§ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø· Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ù„ÙƒÙ† PIL Ù„Ø§ ØªØ³Ù…Ø­ Ø¨ØªØºÙŠÙŠØ± Ø­Ø¬Ù…Ù‡ Ø¨Ø³Ù‡ÙˆÙ„Ø©)
        return ImageFont.load_default()

    title_font = get_font(title_font_size, bold=True)
    label_font = get_font(label_font_size)
    value_font = get_font(value_font_size)

    draw.rectangle([(0, 0), (size[0], 150)], fill=(218, 165, 32))
    draw.text((120, 40), "H-TRACING", fill=(0, 0, 139), font=title_font)

    photo_x, photo_y = 180, 320
    photo_size = (950, 950)
    draw.rectangle([(photo_x, photo_y), (photo_x + photo_size[0], photo_y + photo_size[1])],
                   outline=(80, 80, 80), width=10, fill=(230, 230, 230))

    if 'Photo' in data and data['Photo']:
        try:
            photo_bytes = base64.b64decode(data['Photo'].split(',')[1])
            personal_photo = Image.open(io.BytesIO(photo_bytes))
            personal_photo = personal_photo.resize(photo_size, Image.LANCZOS)
            img.paste(personal_photo, (photo_x, photo_y))
        except Exception as e:
            logger.warning(f"Failed to load personal photo: {e}")
            draw.text((photo_x + 120, photo_y + photo_size[1] // 2 - 120), "YOUR\nPHOTO\nHERE",
                      fill=(120, 120, 120), font=title_font, align="center")
    else:
        draw.text((photo_x + 120, photo_y + photo_size[1] // 2 - 120), "YOUR\nPHOTO\nHERE",
                  fill=(120, 120, 120), font=title_font, align="center")

    x_label = photo_x + photo_size[0] + 250
    x_value = x_label + 1100  # ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù‚ÙŠÙ…Ø© Ù„ØªØµØ¨Ø­ Ø£ÙˆØ¶Ø­
    y_start = 350
    line_height = 190  # Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø³Ø·ÙˆØ± Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ø®Ø· Ø§Ù„Ø£ÙƒØ¨Ø±
    fields = [
        ("English Name:", 'English Name'),
        ("Arabic Name:", 'Arabic Name'),
        ("Unified Number:", 'Unified Number'),
        ("EID Number:", 'EID Number'),
        ("EID Expire Date:", 'EID Expire Date'),
        ("Visa Issue Place:", 'Visa Issue Place'),
        ("Profession:", 'Profession'),
        ("English Sponsor Name:", 'English Sponsor Name'),
        ("Arabic Sponsor Name:", 'Arabic Sponsor Name'),
        ("Related Individuals:", 'Related Individuals')
    ]

    y = y_start
    max_value_width = size[0] - x_value - 200
    for label_text, key in fields:
        value = data.get(key, '')
        if key in ['EID Expire Date']:
            value = format_date(value)
        value_display = reshape_arabic(str(value))
        draw.text((x_label, y), label_text, fill=(0, 0, 0), font=label_font)
        wrapped_lines = wrap_text(draw, value_display, value_font, max_value_width)
        for line in wrapped_lines:
            draw.text((x_value, y), line, fill=(0, 0, 100), font=value_font)
            y += line_height // 1.8
        y += line_height - (len(wrapped_lines) - 1) * (line_height // 1.8)

    buffer = io.BytesIO()
    img.save(buffer, format="JPEG", quality=98)
    buffer.seek(0)
    return buffer

class ICPScraper:
    def __init__(self):
        self.driver = None
        self.wait = None
        self.url = "https://smartservices.icp.gov.ae/echannels/web/client/guest/index.html#/issueQrCode"

    def setup_driver(self):
        options = webdriver.ChromeOptions()
        options.add_argument("--headless=new")
        options.add_argument("--disable-gpu")
        options.add_argument("--window-size=1920,1080")
        options.add_argument("--no-sandbox")
        options.add_argument("--disable-dev-shm-usage")
        options.add_argument("--disable-blink-features=AutomationControlled")
        options.add_argument("user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36")
        options.set_capability('goog:loggingPrefs', {'performance': 'ALL'})
        options.add_experimental_option("excludeSwitches", ["enable-automation", "enable-logging"])
        options.add_experimental_option("useAutomationExtension", False)
        
        import os
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ØªØµÙØ­ ÙÙŠ Ù…Ø³Ø§Ø±Ø§Øª Linux Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© (Streamlit Cloud)
        chrome_bin = "/usr/bin/chromium"
        if not os.path.exists(chrome_bin):
            chrome_bin = "/usr/bin/chromium-browser"
            
        if os.path.exists(chrome_bin):
            options.binary_location = chrome_bin
            # ÙÙŠ Streamlit CloudØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ù…Ø«Ø¨Øª ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø¨Ø§Ø´Ø±Ø© Ù„ØªØ¬Ù†Ø¨ ØªØ¹Ø§Ø±Ø¶ Ø§Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª
            service = Service("/usr/bin/chromedriver") if os.path.exists("/usr/bin/chromedriver") else Service(ChromeDriverManager().install())
        else:
            # Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ù„ÙŠ (Windows/Mac)
            service = Service(ChromeDriverManager().install())
        
        self.driver = webdriver.Chrome(service=service, options=options)
        
        self.driver.execute_cdp_cmd("Page.addScriptToEvaluateOnNewDocument", {
            "source": "Object.defineProperty(navigator, 'webdriver', {get: () => undefined})"
        })
        
        self.wait = WebDriverWait(self.driver, 30)

    def safe_clear_and_fill(self, element, value):
        element.send_keys(Keys.CONTROL + "a")
        element.send_keys(Keys.BACKSPACE)
        time.sleep(0.5)
        element.send_keys(str(value))

    def select_from_dropdown(self, label_name, search_value):
        try:
            dropdown_xpath = f"//label[contains(text(),'{label_name}')]/following::div[contains(@class,'ui-select-container')][1]"
            container = self.wait.until(EC.element_to_be_clickable((By.XPATH, dropdown_xpath)))
            self.driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", container)
            container.click()
            time.sleep(1)
            search_input = self.wait.until(EC.visibility_of_element_located((By.XPATH, f"//label[contains(text(),'{label_name}')]/following::input[not(@type='hidden')][1]")))
            self.safe_clear_and_fill(search_input, search_value)
            time.sleep(2)
            result_xpath = f"//div[contains(@class,'ui-select-choices')]//span[contains(translate(., 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), '{str(search_value).lower()}')]"
            result_item = self.wait.until(EC.element_to_be_clickable((By.XPATH, result_xpath)))
            self.driver.execute_script("arguments[0].click();", result_item)
            time.sleep(1)
        except Exception as e:
            logger.warning(f"Dropdown selection failed for {label_name}: {e}")

    def capture_network_data(self):
        logger.info(" [>] Analyzing Network logs...")
        time.sleep(20)
        try:
            logs = self.driver.get_log('performance')
            for entry in reversed(logs):
                message = json.loads(entry['message'])['message']
                if 'Network.responseReceived' in message['method']:
                    params = message.get('params', {})
                    request_id = params.get('requestId')
                    try:
                        resp_obj = self.driver.execute_cdp_cmd('Network.getResponseBody', {'requestId': request_id})
                        body = resp_obj['body']
                        if 'isValid' in body:
                            data = json.loads(body)
                            if 'isValid' in data:
                                if data['isValid']:
                                    personal_info = data.get('personalInfo', {})
                                    info = personal_info[0] if isinstance(personal_info, list) and personal_info else personal_info
                                    return {
                                        'English Name': info.get('englishFullName'),
                                        'Arabic Name': info.get('arabicFullName'),
                                        'Unified Number': info.get('unifiedNumber'),
                                        'EID Number': info.get('identityNumber'),
                                        'EID Expire Date': info.get('identityExpireDate'),
                                        'Visa Issue Place': info.get('englishIdentityIssuePlace'),
                                        'Profession': info.get('englishProfession'),
                                        'English Sponsor Name': info.get('englishSponsorName'),
                                        'Arabic Sponsor Name': info.get('arabicSponsorName'),
                                        'Status': 'Found'
                                    }
                                elif data['isValid'] is False:
                                    return {'Status': 'Not Found'}
                    except:
                        continue
        except Exception as e:
            logger.error(f"Capture Error: {e}")
        return {'Status': 'Not Found'}

    def extract_qr_url(self):
        self.driver.execute_script("""
            if (typeof jsQR === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js';
                document.head.appendChild(script);
            }
        """)
        time.sleep(3)
        qr_url = self.driver.execute_async_script("""
            const callback = arguments[arguments.length - 1];
            const extractQR = async () => {
                const getQR = () => {
                    let c = document.querySelector('canvas');
                    if (c) return c;
                    let i = document.querySelectorAll('img');
                    for (let img of i) {
                        if (img.src && (img.src.includes('data:image') || img.src.includes('blob') || img.src.includes('qr'))) return img;
                    }
                    return null;
                };
                const el = getQR();
                if (!el) return null;
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.src = el.toDataURL ? el.toDataURL() : el.src;
                return new Promise((resolve) => {
                    img.onload = () => {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        context.drawImage(img, 0, 0);
                        const imageData = context.getImageData(0, 0, img.width, img.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height);
                        resolve(code ? code.data : null);
                    };
                    img.onerror = () => resolve(null);
                });
            };
            extractQR().then(callback);
        """)
        return qr_url

    def perform_single_search(self, passport_number, nationality, date_of_birth, gender):
        self.setup_driver()
        try:
            self.driver.get(self.url)
            logger.info(f"[*] Processing Passport: {passport_number}")
            time.sleep(3)
            self.driver.execute_script("""
                var radio = document.querySelector('input[value="personalInfo"]') || document.querySelector('input[ng-value="0"]');
                if(radio) {
                    radio.click();
                    radio.dispatchEvent(new Event('change', { bubbles: true }));
                }
            """)
            time.sleep(2)
            self.select_from_dropdown('Current Nationality', nationality)
            self.select_from_dropdown('Passport Type', 'ORDINARY PASSPORT')
            ppt_field = self.wait.until(EC.presence_of_element_located((By.XPATH, "//label[contains(text(),'Passport Number')]/following::input[1]")))
            self.safe_clear_and_fill(ppt_field, passport_number)
            dob_formatted = pd.to_datetime(date_of_birth, dayfirst=True).strftime('%d/%m/%Y')
            dob_field = self.driver.find_element(By.XPATH, "//label[contains(text(),'Date of Birth')]/following::input[1]")
            self.safe_clear_and_fill(dob_field, dob_formatted)
            dob_field.send_keys(Keys.TAB)
            gender_field = self.driver.find_element(By.XPATH, "//label[contains(text(),'Gender')]/following::input[1]")
            self.safe_clear_and_fill(gender_field, gender)
            gender_field.send_keys(Keys.TAB)
            related_field = self.driver.find_element(By.XPATH, "//label[contains(text(),'related to your file')]/following::input[1]")
            result = {'Status': 'Not Found'}
            related_count = 0
            logger.info("Trying related count: 0")
            related_field = self.wait.until(EC.presence_of_element_located((By.XPATH, "//label[contains(text(),'related to your file')]/following::input[1]")))
            related_field.clear()
            related_field.send_keys("0")
            related_field.send_keys(Keys.TAB)
            time.sleep(1)
            search_button = self.wait.until(EC.element_to_be_clickable((By.CSS_SELECTOR, "button[ng-click='search()']")))
            self.driver.execute_script("arguments[0].removeAttribute('disabled'); arguments[0].classList.remove('disabled'); arguments[0].click();", search_button)
            time.sleep(5)
            temp_result = self.capture_network_data()
            if temp_result.get('Status') == 'Found':
                result = temp_result
                related_count = 0
            else:
                for rc in range(1, 6):
                    logger.info(f"Trying related count: {rc}")
                    related_field.clear()
                    related_field.send_keys(str(rc))
                    related_field.send_keys(Keys.TAB)
                    time.sleep(1)
                    search_button = self.wait.until(EC.element_to_be_clickable((By.CSS_SELECTOR, "button[ng-click='search()']")))
                    self.driver.execute_script("arguments[0].removeAttribute('disabled'); arguments[0].classList.remove('disabled'); arguments[0].click();", search_button)
                    time.sleep(5)
                    temp_result = self.capture_network_data()
                    if temp_result.get('Status') == 'Found':
                        result = temp_result
                        related_count = rc
                        break
            if result.get('Status') == 'Found':
                result['Related Individuals'] = str(related_count)
                if 'EID Expire Date' in result:
                    result['EID Expire Date'] = format_date(result['EID Expire Date'])
                if 'Date of Birth' in result:
                    result['Date of Birth'] = format_date(result['Date of Birth'])
                result['Passport Number'] = passport_number
                result['Nationality'] = nationality
                result['Gender'] = gender
                qr_url = self.extract_qr_url()
                if qr_url:
                    logger.info(f"Extracted QR URL: {qr_url}")
                    self.driver.get(qr_url)
                    time.sleep(15)
                    try:
                        photo_elements = self.driver.find_elements(By.CSS_SELECTOR, 'img[src^="data:image"]')
                        if photo_elements:
                            photo_element = max(photo_elements, key=lambda el: len(el.get_attribute('src') or ''))
                            photo_src = photo_element.get_attribute('src')
                            if photo_src and 'base64' in photo_src:
                                result['Photo'] = photo_src
                                logger.info("Personal photo extracted successfully (longest base64 selected).")
                            else:
                                logger.warning("Found data:image but no valid base64.")
                        else:
                            logger.warning("No data:image/img elements found on the digital card page.")
                    except Exception as e:
                        logger.warning(f"Failed to extract personal photo: {e}")
            return result
        except Exception as e:
            logger.error(f"Error during search: {e}")
            return {'Passport Number': passport_number, 'Nationality': nationality, 'Date of Birth': date_of_birth, 'Gender': gender, 'Status': 'Error'}
        finally:
            if self.driver:
                self.driver.quit()

def toggle_card():
    st.session_state.card_enlarged = not st.session_state.card_enlarged

tab1, tab2 = st.tabs(["Single Search", "Upload Excel File"])

with tab1:
    st.subheader("Single Person Search")
    c1, c2, c3 = st.columns(3)
    p_in = c1.text_input("Passport Number", key="s_p")
    n_in = c2.selectbox("Nationality", countries_list, key="s_n")
    d_in = c3.date_input("Date of Birth", value=None, min_value=datetime(1900,1,1), format="DD/MM/YYYY", key="s_d")
    g_in = st.radio("Gender", options=["Male", "Female"], index=0, key="s_g")
   
    col_btn1, col_btn_stop, col_btn2 = st.columns(3)
    with col_btn1:
        if st.button("Search Now", key="single_search_button"):
            if p_in and n_in != "Select Nationality" and d_in:
                with st.spinner("Searching..."):
                    scraper = ICPScraper()
                    gender_value = "1" if g_in == "Male" else "0"
                    res = scraper.perform_single_search(p_in, n_in, d_in.strftime("%d/%m/%Y"), gender_value)
                    st.session_state.single_result = res or None
   
    with col_btn_stop:
        if st.button("ğŸ›‘ Stop", key="stop_single_search"):
            st.session_state.single_result = None
            st.rerun()
   
    with col_btn2:
        if st.button("Clear", key="clear_button"):
            st.session_state.single_result = None
            st.rerun()
   
    single_table_area = st.empty()
    card_image_area = st.empty()
    if st.session_state.single_result:
        displayed_fields = ['English Name', 'Arabic Name', 'Unified Number', 'EID Number',
                            'EID Expire Date', 'Visa Issue Place', 'Profession',
                            'English Sponsor Name', 'Arabic Sponsor Name', 'Related Individuals', 'Status']
        filtered_df = pd.DataFrame([{k: v for k, v in st.session_state.single_result.items() if k in displayed_fields}])
        single_table_area.table(apply_styling(filtered_df))
        if st.session_state.single_result.get('Status') == 'Found':
            card_buffer = create_card_image(st.session_state.single_result)
            card_width = 1400 if st.session_state.card_enlarged else 700
            card_image_area.image(card_buffer, caption="Generated Card (Preview)", width=card_width)
            st.button("Enlarge Card" if not st.session_state.card_enlarged else "Shrink Card", on_click=toggle_card)
            st.download_button(
                label="ğŸ“¥ Download Card",
                data=card_buffer,
                file_name=f"card_{st.session_state.single_result.get('Unified Number', 'unknown')}.jpg",
                mime="image/jpeg"
            )

with tab2:
    st.subheader("Batch Processing Control")
    uploaded_file = st.file_uploader("Upload Excel", type=["xlsx"])
    if uploaded_file:
        df_original = pd.read_excel(uploaded_file)
        df_show = df_original.copy()
        df_show.index = range(1, len(df_show) + 1)
        st.write(f"Total records: {len(df_original)}")
        st.dataframe(df_show, height=150, use_container_width=True)
        col_ctrl1, col_ctrl2, col_ctrl3 = st.columns(3)
        if col_ctrl1.button("â–¶ï¸ Start / Resume"):
            st.session_state.run_state = 'running'
            if st.session_state.start_time_ref is None:
                st.session_state.start_time_ref = time.time()
        if col_ctrl2.button("â¸ï¸ Pause"):
            st.session_state.run_state = 'paused'
        if col_ctrl3.button("â¹ï¸ Stop & Reset"):
            st.session_state.run_state = 'stopped'
            st.session_state.batch_results = []
            st.session_state.start_time_ref = None
            st.rerun()
        progress_bar = st.progress(0)
        status_text = st.empty()
        stats_area = st.empty()
        live_table_area = st.empty()
        actual_success = 0
        for i, row in df_original.iterrows():
            while st.session_state.run_state == 'paused':
                status_text.warning("Paused...")
                time.sleep(1)
            if st.session_state.run_state == 'stopped':
                break
            if i < len(st.session_state.batch_results):
                if st.session_state.batch_results[i].get("Status") == "Found":
                    actual_success += 1
                displayed_fields = ['English Name', 'Arabic Name', 'Unified Number', 'EID Number',
                                    'EID Expire Date', 'Visa Issue Place', 'Profession',
                                    'English Sponsor Name', 'Arabic Sponsor Name', 'Related Individuals', 'Status']
                filtered_batch_df = pd.DataFrame([{k: v for k, v in item.items() if k in displayed_fields}
                                                  for item in st.session_state.batch_results])
                live_table_area.table(apply_styling(filtered_batch_df))
                progress_bar.progress((i + 1) / len(df_original))
                continue
            p_num = str(row.get('Passport Number', '')).strip()
            nat = str(row.get('Nationality', 'Egypt')).strip()
            try:
                dob = pd.to_datetime(row.get('Date of Birth')).strftime('%d/%m/%Y')
            except:
                dob = str(row.get('Date of Birth', ''))
            gender = str(row.get('Gender', '1')).strip()
            status_text.info(f"Processing {i+1}/{len(df_original)}: {p_num}")
            scraper = ICPScraper()
            res = scraper.perform_single_search(p_num, nat, dob, gender)
            if res.get('Status') == 'Found':
                actual_success += 1
            st.session_state.batch_results.append(res)
            elapsed = time.time() - (st.session_state.start_time_ref or time.time())
            stats_area.markdown(f"âœ… **Success:** {actual_success} | â±ï¸ **Time:** {format_time(elapsed)}")
            displayed_fields = ['English Name', 'Arabic Name', 'Unified Number', 'EID Number',
                                'EID Expire Date', 'Visa Issue Place', 'Profession',
                                'English Sponsor Name', 'Arabic Sponsor Name', 'Related Individuals', 'Status']
            filtered_batch_df = pd.DataFrame([{k: v for k, v in item.items() if k in displayed_fields}
                                              for item in st.session_state.batch_results])
            live_table_area.table(apply_styling(filtered_batch_df))
            progress_bar.progress((i + 1) / len(df_original))
        if len(st.session_state.batch_results) == len(df_original) and len(df_original) > 0:
            st.success("Search Finished!")
            displayed_fields = ['English Name', 'Arabic Name', 'Unified Number', 'EID Number',
                                'EID Expire Date', 'Visa Issue Place', 'Profession',
                                'English Sponsor Name', 'Arabic Sponsor Name', 'Related Individuals', 'Status']
            final_df = pd.DataFrame([{k: v for k, v in item.items() if k in displayed_fields}
                                     for item in st.session_state.batch_results])
            excel_data = to_excel(final_df)
            st.download_button(
                label="ğŸ“¥ Download Results",
                data=excel_data,
                file_name=f"search_results_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx",
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                key="dl_results"
            )
